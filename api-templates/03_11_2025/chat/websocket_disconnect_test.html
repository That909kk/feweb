<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Disconnect Test</title>
    
    <!-- SockJS and STOMP libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section h2 {
            color: #dc3545;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #dc3545;
            padding-bottom: 10px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .control-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-connect {
            background: #28a745;
            color: white;
        }
        
        .btn-disconnect {
            background: #dc3545;
            color: white;
        }
        
        .btn-send {
            background: #667eea;
            color: white;
        }
        
        .btn-clear {
            background: #ffc107;
            color: #333;
        }
        
        .status {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
        }
        
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .log-container {
            height: 500px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid transparent;
        }
        
        .log-entry.info {
            border-left-color: #17a2b8;
            color: #17a2b8;
        }
        
        .log-entry.success {
            border-left-color: #28a745;
            color: #28a745;
        }
        
        .log-entry.warning {
            border-left-color: #ffc107;
            color: #ffc107;
        }
        
        .log-entry.error {
            border-left-color: #dc3545;
            color: #dc3545;
        }
        
        .timestamp {
            color: #999;
            font-size: 11px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .alert {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .alert strong {
            display: block;
            margin-bottom: 10px;
            color: #856404;
        }
        
        .alert ul {
            margin-left: 20px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç WebSocket Disconnect Test Tool</h1>
            <p>Ki·ªÉm tra t·ª± ƒë·ªông disconnect sau khi g·ª≠i tin nh·∫Øn ho·∫∑c sau m·ªôt kho·∫£ng th·ªùi gian</p>
        </div>
        
        <div class="content">
            <div class="alert">
                <strong>üéØ M·ª•c ƒë√≠ch test:</strong>
                <ul>
                    <li>Ki·ªÉm tra WebSocket c√≥ t·ª± disconnect sau khi g·ª≠i tin nh·∫Øn kh√¥ng</li>
                    <li>Ki·ªÉm tra WebSocket c√≥ t·ª± disconnect sau m·ªôt kho·∫£ng th·ªùi gian idle kh√¥ng</li>
                    <li>Monitor heartbeat v√† connection state li√™n t·ª•c</li>
                    <li>ƒêo th·ªùi gian connection uptime</li>
                </ul>
            </div>
            
            <div class="section">
                <h2>‚öôÔ∏è C·∫•u h√¨nh Test</h2>
                
                <div id="connectionStatus" class="status disconnected">
                    ‚≠ï Ch∆∞a k·∫øt n·ªëi
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="uptime">0s</div>
                        <div class="stat-label">Connection Uptime</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="messageCount">0</div>
                        <div class="stat-label">Messages Sent</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="disconnectCount">0</div>
                        <div class="stat-label">Disconnects</div>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>üÜî Conversation ID:</label>
                    <input type="text" id="conversationId" value="" placeholder="Nh·∫≠p UUID conversation">
                </div>
                
                <div>
                    <button class="btn-connect" onclick="connectWebSocket()">‚úÖ Connect & Monitor</button>
                    <button class="btn-disconnect" onclick="disconnectWebSocket()">‚ùå Disconnect</button>
                    <button class="btn-send" onclick="sendTestMessage()">üì§ Send Test Message</button>
                    <button class="btn-clear" onclick="clearLog()">üóëÔ∏è Clear Log</button>
                </div>
            </div>
            
            <div class="section">
                <h2>üìä Connection Log & Events</h2>
                <div id="logContainer" class="log-container">
                    <div class="log-entry info">
                        <span class="timestamp">[Waiting]</span> Ch·ªù k·∫øt n·ªëi WebSocket...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let connectionStartTime = null;
        let uptimeInterval = null;
        let heartbeatCheckInterval = null;
        let messageCount = 0;
        let disconnectCount = 0;
        let isManualDisconnect = false;
        
        function log(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString('vi-VN', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit', 
                second: '2-digit',
                fractionalSecondDigits: 3
            });
            
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            container.appendChild(entry);
            
            // Auto scroll
            container.scrollTop = container.scrollHeight;
        }
        
        function updateStatus(status, message) {
            const statusDiv = document.getElementById('connectionStatus');
            
            switch(status) {
                case 'connected':
                    statusDiv.className = 'status connected';
                    statusDiv.innerHTML = `‚úÖ ${message}`;
                    break;
                case 'disconnected':
                    statusDiv.className = 'status disconnected';
                    statusDiv.innerHTML = `‚≠ï ${message}`;
                    break;
            }
        }
        
        function updateUptime() {
            if (!connectionStartTime) return;
            
            const now = Date.now();
            const elapsed = Math.floor((now - connectionStartTime) / 1000);
            
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            
            let uptimeStr = '';
            if (hours > 0) uptimeStr += `${hours}h `;
            if (minutes > 0) uptimeStr += `${minutes}m `;
            uptimeStr += `${seconds}s`;
            
            document.getElementById('uptime').textContent = uptimeStr;
        }
        
        function startUptimeCounter() {
            connectionStartTime = Date.now();
            uptimeInterval = setInterval(updateUptime, 1000);
        }
        
        function stopUptimeCounter() {
            if (uptimeInterval) {
                clearInterval(uptimeInterval);
                uptimeInterval = null;
            }
            connectionStartTime = null;
        }
        
        function checkHeartbeat() {
            if (stompClient && stompClient.ws) {
                const readyState = stompClient.ws.readyState;
                const states = {
                    0: 'CONNECTING',
                    1: 'OPEN',
                    2: 'CLOSING',
                    3: 'CLOSED'
                };
                
                log(`üíì Heartbeat check - WebSocket State: ${states[readyState]} (${readyState})`, 'info');
                
                if (readyState === 3 && !isManualDisconnect) {
                    log('‚ùå PH√ÅT HI·ªÜN: WebSocket ƒë√£ b·ªã disconnect t·ª± ƒë·ªông!', 'error');
                    handleUnexpectedDisconnect();
                }
            }
        }
        
        function startHeartbeatMonitor() {
            // Check heartbeat every 5 seconds
            heartbeatCheckInterval = setInterval(checkHeartbeat, 5000);
            log('üíì B·∫Øt ƒë·∫ßu monitor heartbeat (m·ªói 5 gi√¢y)', 'info');
        }
        
        function stopHeartbeatMonitor() {
            if (heartbeatCheckInterval) {
                clearInterval(heartbeatCheckInterval);
                heartbeatCheckInterval = null;
            }
        }
        
        function handleUnexpectedDisconnect() {
            disconnectCount++;
            document.getElementById('disconnectCount').textContent = disconnectCount;
            stopUptimeCounter();
            stopHeartbeatMonitor();
            updateStatus('disconnected', 'ƒê√£ b·ªã disconnect t·ª± ƒë·ªông');
        }
        
        function connectWebSocket() {
            const conversationId = document.getElementById('conversationId').value;
            
            if (!conversationId) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p Conversation ID');
                return;
            }
            
            log('üîå ƒêang kh·ªüi t·∫°o k·∫øt n·ªëi WebSocket...', 'info');
            
            const socket = new SockJS('http://localhost:8080/ws/chat');
            stompClient = Stomp.over(socket);
            
            // Enable debug ƒë·ªÉ xem chi ti·∫øt
            stompClient.debug = function(str) {
                log(`üêõ STOMP Debug: ${str}`, 'info');
            };
            
            isManualDisconnect = false;
            
            stompClient.connect({}, 
                function(frame) {
                    log('‚úÖ WebSocket CONNECTED th√†nh c√¥ng!', 'success');
                    log(`üì° Frame details: ${JSON.stringify(frame)}`, 'info');
                    
                    // Subscribe to conversation
                    stompClient.subscribe(`/topic/conversation/${conversationId}`, function(message) {
                        const chatMessage = JSON.parse(message.body);
                        log(`üì® Nh·∫≠n tin nh·∫Øn real-time: ${JSON.stringify(chatMessage)}`, 'success');
                        
                        // Ki·ªÉm tra connection state sau khi nh·∫≠n tin nh·∫Øn
                        setTimeout(() => {
                            checkConnectionAfterMessage();
                        }, 1000);
                    });
                    
                    log(`‚úÖ ƒê√£ subscribe: /topic/conversation/${conversationId}`, 'success');
                    
                    updateStatus('connected', `ƒê√£ k·∫øt n·ªëi - Subscribe: ${conversationId}`);
                    startUptimeCounter();
                    startHeartbeatMonitor();
                    
                    // Log connection info
                    if (stompClient.ws) {
                        log(`üìä WebSocket ReadyState: ${stompClient.ws.readyState} (1=OPEN)`, 'info');
                        log(`üìä WebSocket URL: ${stompClient.ws.url}`, 'info');
                    }
                },
                function(error) {
                    log(`‚ùå L·ªói k·∫øt n·ªëi: ${JSON.stringify(error)}`, 'error');
                    updateStatus('disconnected', 'L·ªói k·∫øt n·ªëi');
                    
                    if (!isManualDisconnect) {
                        handleUnexpectedDisconnect();
                    }
                }
            );
            
            // Monitor socket close event
            socket.onclose = function(event) {
                log(`‚ö†Ô∏è Socket onclose event triggered - Code: ${event.code}, Reason: ${event.reason}, Clean: ${event.wasClean}`, 'warning');
                
                if (!isManualDisconnect) {
                    log('‚ùå PH√ÅT HI·ªÜN: Socket b·ªã close t·ª± ƒë·ªông (kh√¥ng ph·∫£i manual disconnect)!', 'error');
                    handleUnexpectedDisconnect();
                }
            };
        }
        
        function checkConnectionAfterMessage() {
            if (stompClient && stompClient.ws) {
                const readyState = stompClient.ws.readyState;
                
                if (readyState === 1) {
                    log('‚úÖ KI·ªÇM TRA: WebSocket v·∫´n OPEN sau khi nh·∫≠n tin nh·∫Øn', 'success');
                } else {
                    log(`‚ùå PH√ÅT HI·ªÜN: WebSocket b·ªã disconnect sau khi nh·∫≠n tin nh·∫Øn! State: ${readyState}`, 'error');
                    handleUnexpectedDisconnect();
                }
            }
        }
        
        function disconnectWebSocket() {
            if (stompClient !== null && stompClient.connected) {
                isManualDisconnect = true;
                
                stompClient.disconnect(function() {
                    log('üëã ƒê√£ disconnect th·ªß c√¥ng (manual)', 'warning');
                    updateStatus('disconnected', 'ƒê√£ disconnect th·ªß c√¥ng');
                    stopUptimeCounter();
                    stopHeartbeatMonitor();
                });
            } else {
                log('‚ö†Ô∏è Kh√¥ng c√≥ k·∫øt n·ªëi ƒë·ªÉ disconnect', 'warning');
            }
        }
        
        function sendTestMessage() {
            if (!stompClient || !stompClient.connected) {
                alert('‚ö†Ô∏è Ch∆∞a k·∫øt n·ªëi WebSocket!');
                return;
            }
            
            const conversationId = document.getElementById('conversationId').value;
            messageCount++;
            document.getElementById('messageCount').textContent = messageCount;
            
            const testMessage = {
                conversationId: conversationId,
                senderId: 'test-sender-001',
                senderName: 'Test User',
                messageType: 'TEXT',
                content: `Test message #${messageCount} - ${new Date().toLocaleTimeString()}`,
                timestamp: new Date().toISOString()
            };
            
            log(`üì§ G·ª≠i test message #${messageCount}...`, 'info');
            
            stompClient.send('/app/chat.send', {}, JSON.stringify(testMessage));
            
            log(`‚úÖ ƒê√£ g·ª≠i tin nh·∫Øn`, 'success');
            
            // Check connection sau 2 gi√¢y
            setTimeout(() => {
                checkConnectionAfterSend();
            }, 2000);
        }
        
        function checkConnectionAfterSend() {
            if (stompClient && stompClient.ws) {
                const readyState = stompClient.ws.readyState;
                
                if (readyState === 1) {
                    log('‚úÖ KI·ªÇM TRA: WebSocket v·∫´n OPEN sau khi g·ª≠i tin nh·∫Øn', 'success');
                } else {
                    log(`‚ùå PH√ÅT HI·ªÜN: WebSocket b·ªã disconnect sau khi g·ª≠i tin nh·∫Øn! State: ${readyState}`, 'error');
                    handleUnexpectedDisconnect();
                }
            }
        }
        
        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
            log('üóëÔ∏è ƒê√£ x√≥a log', 'info');
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (stompClient !== null && stompClient.connected) {
                isManualDisconnect = true;
                stompClient.disconnect();
            }
            stopUptimeCounter();
            stopHeartbeatMonitor();
        });
        
        // Initial log
        log('üöÄ WebSocket Disconnect Test Tool ƒë√£ s·∫µn s√†ng', 'success');
        log('üí° Nh·∫≠p Conversation ID v√† nh·∫•n "Connect & Monitor" ƒë·ªÉ b·∫Øt ƒë·∫ßu', 'info');
    </script>
</body>
</html>
